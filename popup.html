<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YouTube Watch Logger</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 12px; width: 380px; }
      header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
      h1 { font-size: 16px; margin: 0; }
      .controls { display: flex; gap: 8px; margin: 8px 0 12px; }
      input[type="search"] { flex: 1; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; }
      button { padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer; }
      button:hover { background: #eee; }
      .entry { border-top: 1px solid #eee; padding: 8px 0; }
      .title { font-weight: 600; font-size: 13px; margin: 0 0 2px; }
      .meta { color: #555; font-size: 12px; }
      .empty { color: #888; font-size: 12px; padding: 24px 0; text-align: center; }
      .row { display: flex; gap: 6px; align-items: center; }
      .pill { font-size: 11px; background: #eef3ff; color: #2b57d3; padding: 2px 6px; border-radius: 999px; }
      a { text-decoration: none; color: #1a73e8; }
      .muted { color: #777; }
      .wrap { white-space: normal; word-wrap: break-word; }
    </style>
  </head>
  <body>
    <header>
      <h1>YouTube Watch Logger</h1>
      <a href="options.html" target="_blank" title="Settings">⚙️</a>
    </header>

    <div class="controls">
      <input id="q" type="search" placeholder="Filter by title/channel" />
      <button id="export">Export CSV</button>
      <button id="clear" title="Clear log">Clear</button>
    </div>

    <div id="list"></div>

    <script src="popup.js"></script>
  </body>
</html>

# ──────────────────────────────────────────────────────────────────────────────
# File: popup.js
# ──────────────────────────────────────────────────────────────────────────────
function fmtDate(iso) {
  const d = new Date(iso);
  return d.toLocaleString();
}

function fmtDur(sec) {
  if (sec == null) return "";
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  const parts = [];
  if (h) parts.push(`${h}h`);
  if (m || h) parts.push(`${m}m`);
  parts.push(`${s}s`);
  return parts.join(" ");
}

function toCsv(rows) {
  const header = ["watchedAt","profile","videoId","title","channelTitle","durationSeconds","url","description"];
  const esc = (s) => '"' + String(s ?? "").replaceAll('"', '""') + '"';
  const lines = [header.join(",")];
  for (const r of rows) {
    lines.push([
      r.watchedAt,
      r.profile,
      r.videoId,
      r.title,
      r.channelTitle,
      r.durationSeconds ?? "",
      r.url,
      r.description
    ].map(esc).join(","));
  }
  return lines.join("\n");
}

function render(list, q="") {
  const root = document.getElementById("list");
  root.innerHTML = "";

  let rows = [...list].sort((a,b) => new Date(b.watchedAt) - new Date(a.watchedAt));
  if (q) {
    const qq = q.toLowerCase();
    rows = rows.filter(r => (r.title||"").toLowerCase().includes(qq) || (r.channelTitle||"").toLowerCase().includes(qq));
  }

  if (!rows.length) {
    root.innerHTML = '<div class="empty">No items logged yet.</div>';
    return;
  }

  for (const r of rows) {
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `
      <div class="row">
        <a class="title wrap" href="${r.url}" target="_blank" rel="noopener noreferrer">${r.title || r.videoId}</a>
        <span class="pill">${r.profile}</span>
      </div>
      <div class="meta">
        <span>${r.channelTitle || ""}</span>
        · <span class="muted">${fmtDur(r.durationSeconds)}</span>
        · <span class="muted">${fmtDate(r.watchedAt)}</span>
      </div>
    `;
    root.appendChild(div);
  }
}

async function loadAndRender() {
  chrome.storage.local.get({ watchLog: [] }, ({ watchLog }) => {
    const q = document.getElementById("q").value.trim();
    render(watchLog || [], q);
  });
}

document.getElementById("q").addEventListener("input", loadAndRender);

document.getElementById("export").addEventListener("click", () => {
  chrome.storage.local.get({ watchLog: [] }, ({ watchLog }) => {
    const csv = toCsv(watchLog || []);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `youtube_watch_log_${Date.now()}.csv`;
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });
});

document.getElementById("clear").addEventListener("click", () => {
  if (!confirm("Clear all logged items?")) return;
  chrome.storage.local.set({ watchLog: [] }, loadAndRender);
});

// Initial render and keep updated when background adds entries
loadAndRender();
chrome.storage.onChanged.addListener((changes, area) => {
  if (area === "local" && changes.watchLog) loadAndRender();
});
